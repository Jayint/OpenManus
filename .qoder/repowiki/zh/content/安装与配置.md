# 安装与配置

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [requirements.txt](file://requirements.txt)
- [setup.py](file://setup.py)
- [config.example.toml](file://config/config.example.toml)
- [config.example-model-anthropic.toml](file://config/config.example-model-anthropic.toml)
- [config.example-model-azure.toml](file://config/config.example-model-azure.toml)
- [config.example-model-ollama.toml](file://config/config.example-model-ollama.toml)
- [config.example-daytona.toml](file://config/config.example-daytona.toml)
- [app/config.py](file://app/config.py)
</cite>

## 目录
1. [安装方法](#安装方法)  
2. [依赖项安装](#依赖项安装)  
3. [配置文件详解](#配置文件详解)  
4. [LLM提供商配置](#llm提供商配置)  
5. [Daytona平台集成](#daytona平台集成)  
6. [常见配置问题排查](#常见配置问题排查)  
7. [最佳实践建议](#最佳实践建议)

## 安装方法

OpenManus支持多种安装方式，推荐使用`uv`进行快速安装和依赖管理。

### 方法一：使用pip安装

1. 创建Python虚拟环境（推荐Python 3.12）：

```bash
python -m venv openmanus-env
source openmanus-env/bin/activate  # Linux/macOS
# 或者在Windows上：
# openmanus-env\Scripts\activate
```

2. 克隆项目并进入目录：

```bash
git clone https://github.com/FoundationAgents/OpenManus.git
cd OpenManus
```

3. 安装依赖：

```bash
pip install -r requirements.txt
```

4. 安装OpenManus包：

```bash
pip install .
```

### 方法二：使用uv安装（推荐）

`uv`是一个快速的Python包安装和解析工具，能显著提升安装速度。

1. 安装uv：

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

2. 克隆项目并进入目录：

```bash
git clone https://github.com/FoundationAgents/OpenManus.git
cd OpenManus
```

3. 创建并激活虚拟环境：

```bash
uv venv --python 3.12
source .venv/bin/activate  # Linux/macOS
# 或在Windows上：
# .venv\Scripts\activate
```

4. 安装依赖：

```bash
uv pip install -r requirements.txt
uv pip install .
```

**Section sources**  
- [README.md](file://README.md#L45-L85)
- [requirements.txt](file://requirements.txt#L1-L43)
- [setup.py](file://setup.py#L1-L50)

## 依赖项安装

OpenManus依赖多个外部工具和库，需按需安装。

### Playwright（可选，用于浏览器自动化）

```bash
playwright install
```

Playwright用于支持浏览器操作功能，如网页浏览、截图、交互等。若不使用浏览器相关功能，可跳过此步骤。

### Docker（用于沙箱环境）

OpenManus支持在Docker沙箱中执行代码，需安装Docker引擎：

- **macOS/Linux**: 从[Docker官网](https://www.docker.com/products/docker-desktop)下载并安装Docker Desktop。
- **Linux命令行安装**：

```bash
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh
sudo usermod -aG docker $USER
```

重启终端以应用权限变更。

### Ollama（本地LLM支持）

若使用本地LLM（如Llama 3.2），需安装Ollama：

```bash
# macOS/Linux
curl -fsSL https://ollama.com/install.sh | sh

# 启动Ollama服务
ollama serve
```

拉取模型：

```bash
ollama pull llama3.2
ollama pull llama3.2-vision  # 若需视觉模型
```

**Section sources**  
- [README.md](file://README.md#L87-L92)
- [requirements.txt](file://requirements.txt#L1-L43)

## 配置文件详解

OpenManus使用TOML格式的配置文件进行配置。默认配置文件为`config/config.toml`，可从示例文件复制：

```bash
cp config/config.example.toml config/config.toml
```

### 配置文件结构

配置文件主要包含以下部分：

- `[llm]`: 全局LLM配置
- `[llm.vision]`: 视觉模型配置
- `[browser]`: 浏览器配置
- `[search]`: 搜索引擎配置
- `[sandbox]`: 沙箱配置
- `[mcp]`: MCP协议配置
- `[runflow]`: 多代理流程配置
- `[daytona]`: Daytona平台集成配置

### 核心配置项说明

#### LLM配置（[llm]）

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `model` | 字符串 | `"claude-3-7-sonnet-20250219"` | 使用的LLM模型名称 |
| `base_url` | 字符串 | `"https://api.anthropic.com/v1/"` | API基础URL |
| `api_key` | 字符串 | `"YOUR_API_KEY"` | API密钥 |
| `max_tokens` | 整数 | `8192` | 响应最大token数 |
| `temperature` | 浮点数 | `0.0` | 生成随机性控制 |
| `api_type` | 字符串 | `""` | API类型（如`azure`, `ollama`） |
| `api_version` | 字符串 | `""` | Azure API版本 |

#### 视觉模型配置（[llm.vision]）

与`[llm]`结构相同，专用于视觉任务。

#### 浏览器配置（[browser]）

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `headless` | 布尔值 | `false` | 是否无头模式运行 |
| `disable_security` | 布尔值 | `true` | 是否禁用安全特性 |
| `extra_chromium_args` | 字符串列表 | `[]` | 浏览器启动参数 |
| `chrome_instance_path` | 字符串 | `""` | 外部Chrome实例路径 |
| `wss_url` | 字符串 | `""` | WebSocket连接URL |
| `cdp_url` | 字符串 | `""` | CDP连接URL |

#### 搜索配置（[search]）

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `engine` | 字符串 | `"Google"` | 主搜索引擎 |
| `fallback_engines` | 字符串列表 | `["DuckDuckGo", "Baidu", "Bing"]` | 备用搜索引擎 |
| `retry_delay` | 整数 | `60` | 重试延迟（秒） |
| `max_retries` | 整数 | `3` | 最大重试次数 |
| `lang` | 字符串 | `"en"` | 搜索语言 |
| `country` | 字符串 | `"us"` | 搜索地区 |

#### 沙箱配置（[sandbox]）

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `use_sandbox` | 布尔值 | `false` | 是否启用沙箱 |
| `image` | 字符串 | `"python:3.12-slim"` | 沙箱镜像 |
| `work_dir` | 字符串 | `"/workspace"` | 工作目录 |
| `memory_limit` | 字符串 | `"512m"` | 内存限制 |
| `cpu_limit` | 浮点数 | `1.0` | CPU限制 |
| `timeout` | 整数 | `300` | 命令超时（秒） |
| `network_enabled` | 布尔值 | `false` | 是否启用网络 |

**Section sources**  
- [config.example.toml](file://config/config.example.toml#L1-L106)
- [app/config.py](file://app/config.py#L93-L104)

## LLM提供商配置

OpenManus支持多种LLM提供商，可通过配置文件切换。

### Anthropic配置

使用`config.example-model-anthropic.toml`作为模板：

```bash
cp config/config.example-model-anthropic.toml config/config.toml
```

修改`api_key`为你的Anthropic API密钥。

### Azure OpenAI配置

使用`config.example-model-azure.toml`作为模板：

```bash
cp config/config.example-model-azure.toml config/config.toml
```

替换以下字段：
- `model`: 部署的模型名称
- `base_url`: Azure端点URL（格式：`{YOUR_ENDPOINT}/openai/deployments/{DEPLOYMENT_ID}`）
- `api_key`: Azure API密钥
- `api_version`: API版本（如`2024-08-01-preview`）

### Ollama配置

使用`config.example-model-ollama.toml`作为模板：

```bash
cp config/config.example-model-ollama.toml config/config.toml
```

确保Ollama服务正在运行（`ollama serve`），并根据需要修改`model`字段。

### 其他提供商

通过修改`base_url`和`api_key`，可适配其他兼容OpenAI API的提供商。

**Section sources**  
- [config.example-model-anthropic.toml](file://config/config.example-model-anthropic.toml#L1-L17)
- [config.example-model-azure.toml](file://config/config.example-model-azure.toml#L1-L19)
- [config.example-model-ollama.toml](file://config/config.example-model-ollama.toml#L1-L18)

## Daytona平台集成

OpenManus支持与Daytona平台集成，实现远程沙箱执行。

### 配置步骤

1. 使用`config.example-daytona.toml`作为模板：

```bash
cp config/config.example-daytona.toml config/config.toml
```

2. 在`[daytona]`部分配置：

```toml
[daytona]
daytona_api_key = "your_api_key_here"
# daytona_server_url = "https://app.daytona.io/api"  # 可选覆盖
# daytona_target = "us"  # 或 "eu"
# sandbox_image_name = "whitezxj/sandbox:0.1.0"  # 建议保持默认
# sandbox_entrypoint = "/usr/bin/supervisord -n -c /etc/supervisor/conf.d/supervisord.conf"  # 建议保持默认
# VNC_password = "123456"  # 可选设置VNC密码
```

3. 获取API密钥：
   - 登录[Daytona平台](https://app.daytona.io)
   - 进入账户设置页面
   - 生成并复制API密钥

### 注意事项

- `sandbox_image_name`和`sandbox_entrypoint`建议保持默认，否则可能导致工具无法使用。
- `VNC_password`若未设置，默认为`123456`，可用于VNC远程连接沙箱。

**Section sources**  
- [config.example-daytona.toml](file://config/config.example-daytona.toml#L1-L115)
- [app/config.py](file://app/config.py#L107-L123)

## 常见配置问题排查

### 1. API密钥无效或未设置

**症状**：启动时报错`Authentication failed`或`Invalid API key`。

**解决方法**：
- 确认`config.toml`中`api_key`已正确填写。
- 检查LLM提供商账户是否有效，API密钥是否过期。

### 2. Playwright浏览器启动失败

**症状**：浏览器操作时报错`Browser closed unexpectedly`。

**解决方法**：
- 确保已运行`playwright install`安装浏览器。
- 若使用外部Chrome，检查`chrome_instance_path`路径是否正确。

### 3. Docker沙箱创建失败

**症状**：沙箱创建时报错`Failed to create sandbox`或`Image not found`。

**解决方法**：
- 确保Docker服务正在运行。
- 检查`image`配置项是否正确，如`python:3.12-slim`。
- 若网络受限，可尝试手动拉取镜像：`docker pull python:3.12-slim`。

### 4. Ollama连接失败

**症状**：调用Ollama模型时报错`Connection refused`。

**解决方法**：
- 确保`ollama serve`命令正在运行。
- 检查`base_url`是否为`http://localhost:11434/v1`。
- 确认模型已下载：`ollama list`。

### 5. Daytona连接失败

**症状**：Daytona相关功能无法使用。

**解决方法**：
- 检查`daytona_api_key`是否正确。
- 确认网络可访问`app.daytona.io`。
- 检查`daytona_target`区域是否正确。

**Section sources**  
- [app/config.py](file://app/config.py#L1-L372)
- [config.example.toml](file://config/config.example.toml#L1-L106)

## 最佳实践建议

### 1. 环境隔离
始终使用虚拟环境（venv或conda）进行安装，避免依赖冲突。

### 2. 配置文件备份
修改`config.toml`前，建议备份原始文件，便于回滚。

### 3. 敏感信息保护
不要将包含API密钥的`config.toml`提交到版本控制系统。建议将其加入`.gitignore`。

### 4. 性能优化
- 对于本地LLM，确保系统有足够内存和GPU资源。
- 调整`max_tokens`和`temperature`以平衡生成质量和速度。

### 5. 日志调试
启用详细日志可帮助排查问题。可在代码中调整日志级别或查看控制台输出。

### 6. 版本管理
定期更新OpenManus和依赖库，获取最新功能和安全修复。

**Section sources**  
- [README.md](file://README.md#L1-L196)
- [app/config.py](file://app/config.py#L1-L372)