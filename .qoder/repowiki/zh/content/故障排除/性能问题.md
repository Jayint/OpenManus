# æ€§èƒ½é—®é¢˜

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**  
- [app/logger.py](file://app/logger.py)
- [app/daytona/sandbox.py](file://app/daytona/sandbox.py)
- [app/agent/toolcall.py](file://app/agent/toolcall.py)
- [app/sandbox/core/sandbox.py](file://app/sandbox/core/sandbox.py)
- [app/tool/tool_collection.py](file://app/tool/tool_collection.py)
- [app/sandbox/client.py](file://app/sandbox/client.py)
- [app/config.py](file://app/config.py)
- [app/tool/base.py](file://app/tool/base.py)
- [app/tool/python_execute.py](file://app/tool/python_execute.py)
- [app/tool/bash.py](file://app/tool/bash.py)
- [app/tool/file_operators.py](file://app/tool/file_operators.py)
- [app/tool/chart_visualization/data_visualization.py](file://app/tool/chart_visualization/data_visualization.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„åˆ†æ](#é¡¹ç›®ç»“æ„åˆ†æ)
3. [æ ¸å¿ƒç»„ä»¶åˆ†æ](#æ ¸å¿ƒç»„ä»¶åˆ†æ)
4. [æ€§èƒ½ç“¶é¢ˆè¯†åˆ«](#æ€§èƒ½ç“¶é¢ˆè¯†åˆ«)
5. [æ—¥å¿—æœºåˆ¶ä¸è°ƒè¯•](#æ—¥å¿—æœºåˆ¶ä¸è°ƒè¯•)
6. [æ²™ç®±æ‰§è¡Œæœºåˆ¶åˆ†æ](#æ²™ç®±æ‰§è¡Œæœºåˆ¶åˆ†æ)
7. [å·¥å…·è°ƒç”¨æµç¨‹åˆ†æ](#å·¥å…·è°ƒç”¨æµç¨‹åˆ†æ)
8. [ä¼˜åŒ–å»ºè®®](#ä¼˜åŒ–å»ºè®®)
9. [æ€§èƒ½ç›‘æ§ä¸åŸºå‡†æµ‹è¯•](#æ€§èƒ½ç›‘æ§ä¸åŸºå‡†æµ‹è¯•)
10. [ç»“è®º](#ç»“è®º)

## ç®€ä»‹
æœ¬æ–‡æ¡£æ·±å…¥åˆ†æOpenManusåœ¨é«˜è´Ÿè½½æˆ–å¤æ‚ä»»åŠ¡åœºæ™¯ä¸‹çš„æ€§èƒ½ç“¶é¢ˆï¼ŒåŒ…æ‹¬ä»£ç†å“åº”å»¶è¿Ÿã€å·¥å…·æ‰§è¡Œç¼“æ…¢ã€å†…å­˜å ç”¨è¿‡é«˜ã€æ—¥å¿—I/Oé˜»å¡ç­‰é—®é¢˜ã€‚é€šè¿‡åˆ†æ`app/logger.py`æä¾›çš„æ—¥å¿—è®°å½•æœºåˆ¶ï¼ŒæŒ‡å¯¼ç”¨æˆ·å¦‚ä½•å¯ç”¨è°ƒè¯•æ—¥å¿—å¹¶åˆ†æå…³é”®è·¯å¾„çš„è€—æ—¶åˆ†å¸ƒã€‚ç»“åˆæ²™ç®±æ‰§è¡Œæœºåˆ¶ï¼ˆsandbox.pyï¼‰å’Œå·¥å…·è°ƒç”¨æµç¨‹ï¼ˆtoolcall.pyï¼‰ï¼Œè¯†åˆ«èµ„æºå¯†é›†å‹æ“ä½œï¼Œæå‡ºä¼˜åŒ–å»ºè®®å¦‚å¼‚æ­¥æ‰§è¡Œã€ç»“æœç¼“å­˜ã€å¹¶å‘æ§åˆ¶å’Œæ—¥å¿—çº§åˆ«è°ƒæ•´ã€‚æä¾›æ€§èƒ½ç›‘æ§æŒ‡æ ‡å»ºè®®å’ŒåŸºå‡†æµ‹è¯•æ–¹æ³•ï¼Œå¸®åŠ©ç”¨æˆ·è¯„ä¼°ç³»ç»Ÿä¼˜åŒ–æ•ˆæœã€‚

## é¡¹ç›®ç»“æ„åˆ†æ
OpenManusé¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œä¸»è¦åˆ†ä¸ºagentã€sandboxã€toolã€utilsç­‰æ ¸å¿ƒæ¨¡å—ã€‚agentæ¨¡å—åŒ…å«å„ç§ä»£ç†å®ç°ï¼Œsandboxæ¨¡å—è´Ÿè´£æ²™ç®±ç¯å¢ƒç®¡ç†ï¼Œtoolæ¨¡å—æä¾›å„ç§å·¥å…·å®ç°ï¼Œutilsæ¨¡å—åŒ…å«é€šç”¨å·¥å…·å’Œé…ç½®ã€‚

```mermaid
graph TD
subgraph "æ ¸å¿ƒæ¨¡å—"
Agent[agent]
Sandbox[sandbox]
Tool[tool]
Utils[utils]
end
subgraph "Agentæ¨¡å—"
ToolCallAgent[ToolCallAgent]
SandboxManus[SandboxManus]
Manus[Manus]
end
subgraph "Sandboxæ¨¡å—"
DaytonaSandbox[Daytonaæ²™ç®±]
DockerSandbox[Dockeræ²™ç®±]
SandboxClient[æ²™ç®±å®¢æˆ·ç«¯]
end
subgraph "Toolæ¨¡å—"
PythonExecute[Pythonæ‰§è¡Œ]
Bash[Bashå‘½ä»¤]
FileOperators[æ–‡ä»¶æ“ä½œ]
DataVisualization[æ•°æ®å¯è§†åŒ–]
end
Agent --> Sandbox
Agent --> Tool
Utils --> Agent
Utils --> Sandbox
Utils --> Tool
```

**å›¾æº**  
- [app/agent/toolcall.py](file://app/agent/toolcall.py)
- [app/daytona/sandbox.py](file://app/daytona/sandbox.py)
- [app/tool/tool_collection.py](file://app/tool/tool_collection.py)

## æ ¸å¿ƒç»„ä»¶åˆ†æ
### å·¥å…·è°ƒç”¨ä»£ç†åˆ†æ
`ToolCallAgent`æ˜¯OpenManusçš„æ ¸å¿ƒä»£ç†ç±»ï¼Œè´Ÿè´£å¤„ç†å·¥å…·è°ƒç”¨å’Œæ‰§è¡Œã€‚è¯¥ä»£ç†ç»§æ‰¿è‡ª`ReActAgent`ï¼Œå®ç°äº†æ€è€ƒï¼ˆthinkï¼‰å’Œæ‰§è¡Œï¼ˆactï¼‰çš„å¾ªç¯ã€‚

```mermaid
classDiagram
class ToolCallAgent {
+str name
+str description
+str system_prompt
+str next_step_prompt
+ToolCollection available_tools
+TOOL_CHOICE_TYPE tool_choices
+List[str] special_tool_names
+List[ToolCall] tool_calls
+int max_steps
+Optional[Union[int, bool]] max_observe
+think() bool
+act() str
+execute_tool(command) str
+cleanup() None
+run(request) str
}
class ReActAgent {
+run(request) str
+step() str
}
ToolCallAgent --|> ReActAgent : ç»§æ‰¿
ToolCallAgent --> ToolCollection : ä½¿ç”¨
ToolCallAgent --> ToolCall : ä½¿ç”¨
```

**å›¾æº**  
- [app/agent/toolcall.py](file://app/agent/toolcall.py#L17-L249)

### æ²™ç®±ç®¡ç†åˆ†æ
æ²™ç®±ç®¡ç†ç»„ä»¶è´Ÿè´£åˆ›å»ºã€ç®¡ç†å’Œé”€æ¯æ²™ç®±ç¯å¢ƒï¼Œç¡®ä¿å·¥å…·æ‰§è¡Œçš„å®‰å…¨æ€§å’Œéš”ç¦»æ€§ã€‚

```mermaid
classDiagram
class DockerSandbox {
+SandboxSettings config
+Dict[str, str] volume_bindings
+docker.client client
+Container container
+AsyncDockerizedTerminal terminal
+create() DockerSandbox
+run_command(cmd, timeout) str
+read_file(path) str
+write_file(path, content) str
+copy_from(src_path, dst_path) None
+copy_to(src_path, dst_path) None
+cleanup() None
}
class LocalSandboxClient {
+DockerSandbox sandbox
+create(config, volume_bindings) None
+run_command(command, timeout) str
+copy_from(container_path, local_path) None
+copy_to(local_path, container_path) None
+read_file(path) str
+write_file(path, content) None
+cleanup() None
}
class DaytonaSandbox {
+Daytona daytona
+get_or_start_sandbox(sandbox_id) Sandbox
+create_sandbox(password, project_id) Sandbox
+delete_sandbox(sandbox_id) bool
}
LocalSandboxClient --> DockerSandbox : ä½¿ç”¨
DaytonaSandbox --> DockerSandbox : ä½¿ç”¨
```

**å›¾æº**  
- [app/sandbox/core/sandbox.py](file://app/sandbox/core/sandbox.py#L1-L463)
- [app/sandbox/client.py](file://app/sandbox/client.py#L1-L202)
- [app/daytona/sandbox.py](file://app/daytona/sandbox.py#L1-L166)

## æ€§èƒ½ç“¶é¢ˆè¯†åˆ«
### ä»£ç†å“åº”å»¶è¿Ÿ
ä»£ç†å“åº”å»¶è¿Ÿä¸»è¦æºäºLLMè°ƒç”¨å’Œå·¥å…·æ‰§è¡Œçš„åŒæ­¥ç­‰å¾…ã€‚`ToolCallAgent.think()`æ–¹æ³•ä¸­ï¼ŒLLMè°ƒç”¨æ˜¯å¼‚æ­¥çš„ï¼Œä½†å·¥å…·é€‰æ‹©å’Œæ‰§è¡Œæµç¨‹å­˜åœ¨æ½œåœ¨çš„ä¸²è¡ŒåŒ–ç“¶é¢ˆã€‚

**å…³é”®è·¯å¾„åˆ†æ**ï¼š
1. `think()`æ–¹æ³•ä¸­LLMè°ƒç”¨ç­‰å¾…å“åº”
2. å·¥å…·è°ƒç”¨å†³ç­–å’Œå‚æ•°è§£æ
3. å·¥å…·æ‰§è¡Œçš„ä¸²è¡ŒåŒ–å¤„ç†

```mermaid
sequenceDiagram
participant Agent as ToolCallAgent
participant LLM as LLM
participant Tools as Tools
Agent->>LLM : ask_tool(messages, tools)
LLM-->>Agent : response with tool_calls
Agent->>Agent : è§£æå·¥å…·è°ƒç”¨
loop æ¯ä¸ªå·¥å…·è°ƒç”¨
Agent->>Tools : execute_tool(command)
Tools-->>Agent : æ‰§è¡Œç»“æœ
Agent->>Agent : è®°å½•ç»“æœåˆ°å†…å­˜
end
Agent->>Agent : è¿”å›æ‰§è¡Œç»“æœ
```

**å›¾æº**  
- [app/agent/toolcall.py](file://app/agent/toolcall.py#L38-L128)

### å·¥å…·æ‰§è¡Œç¼“æ…¢
å·¥å…·æ‰§è¡Œç¼“æ…¢ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. **Pythonæ‰§è¡Œå·¥å…·**ï¼šä½¿ç”¨å¤šè¿›ç¨‹æ‰§è¡ŒPythonä»£ç ï¼Œå­˜åœ¨è¿›ç¨‹åˆ›å»ºå¼€é”€
2. **Bashå‘½ä»¤å·¥å…·**ï¼šå‘½ä»¤æ‰§è¡Œè¶…æ—¶è®¾ç½®ä¸º120ç§’ï¼Œé•¿ä»»åŠ¡å¯èƒ½é˜»å¡
3. **æ–‡ä»¶æ“ä½œå·¥å…·**ï¼šæ–‡ä»¶è¯»å†™æ“ä½œæœªè¿›è¡Œæ‰¹é‡å¤„ç†
4. **æ•°æ®å¯è§†åŒ–å·¥å…·**ï¼šè°ƒç”¨Node.jså­è¿›ç¨‹æ‰§è¡Œï¼Œå­˜åœ¨è·¨è¯­è¨€è°ƒç”¨å¼€é”€

```mermaid
flowchart TD
Start([å¼€å§‹å·¥å…·æ‰§è¡Œ]) --> PythonExecute["PythonExecuteå·¥å…·"]
PythonExecute --> CreateProcess["åˆ›å»ºå¤šè¿›ç¨‹"]
CreateProcess --> ExecuteCode["æ‰§è¡ŒPythonä»£ç "]
ExecuteCode --> CheckTimeout["æ£€æŸ¥è¶…æ—¶"]
CheckTimeout --> |è¶…æ—¶| TerminateProcess["ç»ˆæ­¢è¿›ç¨‹"]
CheckTimeout --> |å®Œæˆ| ReturnResult["è¿”å›ç»“æœ"]
Start --> BashTool["Bashå·¥å…·"]
BashTool --> StartSession["å¯åŠ¨Bashä¼šè¯"]
StartSession --> RunCommand["æ‰§è¡Œå‘½ä»¤"]
RunCommand --> CheckExitCode["æ£€æŸ¥é€€å‡ºç "]
CheckExitCode --> |æœªå®Œæˆ| WaitOutput["ç­‰å¾…è¾“å‡º"]
CheckExitCode --> |å®Œæˆ| ReturnOutput["è¿”å›è¾“å‡º"]
Start --> DataViz["æ•°æ®å¯è§†åŒ–å·¥å…·"]
DataViz --> CreateSubprocess["åˆ›å»ºNode.jså­è¿›ç¨‹"]
CreateSubprocess --> SendJSON["å‘é€JSONå‚æ•°"]
SendJSON --> WaitSubprocess["ç­‰å¾…å­è¿›ç¨‹"]
WaitSubprocess --> ReturnViz["è¿”å›å¯è§†åŒ–ç»“æœ"]
```

**å›¾æº**  
- [app/tool/python_execute.py](file://app/tool/python_execute.py#L1-L76)
- [app/tool/bash.py](file://app/tool/bash.py#L1-L159)
- [app/tool/chart_visualization/data_visualization.py](file://app/tool/chart_visualization/data_visualization.py#L1-L264)

### å†…å­˜å ç”¨è¿‡é«˜
å†…å­˜å ç”¨è¿‡é«˜ä¸»è¦æºäºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. **æ²™ç®±ç¯å¢ƒ**ï¼šæ¯ä¸ªæ²™ç®±å®ä¾‹å ç”¨ç‹¬ç«‹çš„Dockerå®¹å™¨èµ„æº
2. **å·¥å…·é›†åˆ**ï¼š`ToolCollection`ä¸­å·¥å…·å®ä¾‹çš„ç´¯ç§¯
3. **ä»£ç†å†…å­˜**ï¼š`Memory`ç±»ä¸­æ¶ˆæ¯çš„ç´¯ç§¯
4. **å¤§æ–‡ä»¶æ“ä½œ**ï¼šæ–‡ä»¶è¯»å†™æ—¶çš„å†…å­˜ç¼“å†²

```mermaid
graph TD
MemoryPressure[å†…å­˜å‹åŠ›æº] --> Sandbox["æ²™ç®±ç¯å¢ƒ"]
MemoryPressure --> Tools["å·¥å…·é›†åˆ"]
MemoryPressure --> AgentMemory["ä»£ç†å†…å­˜"]
MemoryPressure --> FileOps["æ–‡ä»¶æ“ä½œ"]
Sandbox --> |Dockerå®¹å™¨| Container["å®¹å™¨å†…å­˜"]
Container --> CPU["CPUé™åˆ¶"]
Container --> Memory["å†…å­˜é™åˆ¶"]
Container --> Disk["ç£ç›˜é™åˆ¶"]
Tools --> ToolCollection["ToolCollection"]
ToolCollection --> ToolInstances["å·¥å…·å®ä¾‹"]
ToolInstances --> PythonExec["PythonExecute"]
ToolInstances --> Bash["Bash"]
ToolInstances --> FileOp["FileOperators"]
AgentMemory --> Memory["Memoryç±»"]
Memory --> Messages["æ¶ˆæ¯åˆ—è¡¨"]
Messages --> UserMsg["ç”¨æˆ·æ¶ˆæ¯"]
Messages --> SystemMsg["ç³»ç»Ÿæ¶ˆæ¯"]
Messages --> AssistantMsg["åŠ©æ‰‹æ¶ˆæ¯"]
Messages --> ToolMsg["å·¥å…·æ¶ˆæ¯"]
FileOps --> ReadBuffer["è¯»å–ç¼“å†²"]
FileOps --> WriteBuffer["å†™å…¥ç¼“å†²"]
FileOps --> TarStream["Taræµ"]
```

**å›¾æº**  
- [app/sandbox/core/sandbox.py](file://app/sandbox/core/sandbox.py#L1-L463)
- [app/tool/tool_collection.py](file://app/tool/tool_collection.py#L1-L72)
- [app/agent/base.py](file://app/agent/base.py#L1-L197)

### æ—¥å¿—I/Oé˜»å¡
æ—¥å¿—I/Oé˜»å¡ä¸»è¦æºäºæ—¥å¿—è®°å½•çš„åŒæ­¥å†™å…¥å’Œé¢‘ç¹çš„æ—¥å¿—è¾“å‡ºã€‚

```mermaid
sequenceDiagram
participant Agent as ToolCallAgent
participant Logger as Logger
participant File as æ—¥å¿—æ–‡ä»¶
Agent->>Logger : info("âœ¨ Agent's thoughts : ...")
Logger->>File : å†™å…¥æ—¥å¿—
File-->>Logger : å†™å…¥å®Œæˆ
Logger-->>Agent : æ—¥å¿—è®°å½•å®Œæˆ
Agent->>Logger : info("ğŸ› ï¸ Agent selected tools to use")
Logger->>File : å†™å…¥æ—¥å¿—
File-->>Logger : å†™å…¥å®Œæˆ
Logger-->>Agent : æ—¥å¿—è®°å½•å®Œæˆ
Agent->>Logger : info("ğŸ¯ Tool 'python_execute' completed...")
Logger->>File : å†™å…¥æ—¥å¿—
File-->>Logger : å†™å…¥å®Œæˆ
Logger-->>Agent : æ—¥å¿—è®°å½•å®Œæˆ
```

**å›¾æº**  
- [app/logger.py](file://app/logger.py#L1-L43)
- [app/agent/toolcall.py](file://app/agent/toolcall.py#L38-L128)

## æ—¥å¿—æœºåˆ¶ä¸è°ƒè¯•
### æ—¥å¿—é…ç½®åˆ†æ
`app/logger.py`æä¾›äº†çµæ´»çš„æ—¥å¿—é…ç½®æœºåˆ¶ï¼Œæ”¯æŒæ§åˆ¶å°è¾“å‡ºå’Œæ–‡ä»¶è®°å½•ã€‚

```mermaid
classDiagram
class Logger {
+str _print_level
+define_log_level(print_level, logfile_level, name) Logger
+logger Logger
}
Logger : define_log_level(print_level="INFO", logfile_level="DEBUG", name=None)
Logger : logger = define_log_level()
```

**å›¾æº**  
- [app/logger.py](file://app/logger.py#L1-L43)

### è°ƒè¯•æ—¥å¿—å¯ç”¨
è¦å¯ç”¨è°ƒè¯•æ—¥å¿—ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼š

1. **ä¿®æ”¹æ—¥å¿—çº§åˆ«**ï¼šå°†`print_level`è®¾ç½®ä¸º"DEBUG"
2. **æ·»åŠ æ—¥å¿—æ–‡ä»¶**ï¼šé…ç½®æ–‡ä»¶è®°å½•çº§åˆ«ä¸º"DEBUG"
3. **å‘½åæ—¥å¿—æ–‡ä»¶**ï¼šä¸ºä¸åŒä¼šè¯åˆ›å»ºç‹¬ç«‹çš„æ—¥å¿—æ–‡ä»¶

```python
# ç¤ºä¾‹ï¼šå¯ç”¨è°ƒè¯•æ—¥å¿—
from app.logger import define_log_level

# å¯ç”¨è°ƒè¯•æ—¥å¿—
logger = define_log_level(print_level="DEBUG", logfile_level="DEBUG", name="debug_session")
```

**å›¾æº**  
- [app/logger.py](file://app/logger.py#L1-L43)

### å…³é”®è·¯å¾„è€—æ—¶åˆ†æ
é€šè¿‡åˆ†ææ—¥å¿—ä¸­çš„å…³é”®æ—¶é—´ç‚¹ï¼Œå¯ä»¥è¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼š

1. **ä»£ç†æ€è€ƒæ—¶é—´**ï¼šä»`think()`å¼€å§‹åˆ°LLMå“åº”è¿”å›
2. **å·¥å…·æ‰§è¡Œæ—¶é—´**ï¼šæ¯ä¸ªå·¥å…·è°ƒç”¨çš„æ‰§è¡Œè€—æ—¶
3. **æ²™ç®±æ“ä½œæ—¶é—´**ï¼šæ²™ç®±åˆ›å»ºã€å‘½ä»¤æ‰§è¡Œç­‰æ“ä½œè€—æ—¶

```mermaid
flowchart TD
Start([å¼€å§‹ä»£ç†æ‰§è¡Œ]) --> ThinkStart["è®°å½•thinkå¼€å§‹æ—¶é—´"]
ThinkStart --> LLMCall["è°ƒç”¨LLM"]
LLMCall --> LLMResponse["æ¥æ”¶LLMå“åº”"]
LLMResponse --> ThinkEnd["è®°å½•thinkç»“æŸæ—¶é—´"]
ThinkEnd --> ActStart["è®°å½•actå¼€å§‹æ—¶é—´"]
loop æ¯ä¸ªå·¥å…·è°ƒç”¨
ActStart --> ToolStart["è®°å½•å·¥å…·æ‰§è¡Œå¼€å§‹æ—¶é—´"]
ToolStart --> ExecuteTool["æ‰§è¡Œå·¥å…·"]
ExecuteTool --> ToolEnd["è®°å½•å·¥å…·æ‰§è¡Œç»“æŸæ—¶é—´"]
ToolEnd --> CalculateDuration["è®¡ç®—æ‰§è¡Œè€—æ—¶"]
end
CalculateDuration --> ActEnd["è®°å½•actç»“æŸæ—¶é—´"]
ActEnd --> TotalDuration["è®¡ç®—æ€»è€—æ—¶"]
TotalDuration --> LogPerformance["è®°å½•æ€§èƒ½æŒ‡æ ‡"]
```

**å›¾æº**  
- [app/agent/toolcall.py](file://app/agent/toolcall.py#L38-L128)
- [app/logger.py](file://app/logger.py#L1-L43)

## æ²™ç®±æ‰§è¡Œæœºåˆ¶åˆ†æ
### Daytonaæ²™ç®±æœºåˆ¶
Daytonaæ²™ç®±é€šè¿‡APIç®¡ç†è¿œç¨‹æ²™ç®±å®ä¾‹ï¼Œæä¾›æŒä¹…åŒ–çš„æ‰§è¡Œç¯å¢ƒã€‚

```mermaid
sequenceDiagram
participant Agent as Agent
participant Daytona as Daytona
participant Sandbox as æ²™ç®±
Agent->>Daytona : get_or_start_sandbox(sandbox_id)
Daytona->>Sandbox : è·å–æ²™ç®±çŠ¶æ€
alt æ²™ç®±å·²åœæ­¢
Daytona->>Sandbox : start(sandbox)
Daytona->>Sandbox : start_supervisord_session(sandbox)
end
Daytona-->>Agent : è¿”å›å‡†å¤‡å¥½çš„æ²™ç®±
Agent->>Daytona : create_sandbox(password, project_id)
Daytona->>Sandbox : create(params)
Daytona->>Sandbox : start_supervisord_session(sandbox)
Daytona-->>Agent : è¿”å›æ–°åˆ›å»ºçš„æ²™ç®±
```

**å›¾æº**  
- [app/daytona/sandbox.py](file://app/daytona/sandbox.py#L44-L146)

### Dockeræ²™ç®±æœºåˆ¶
Dockeræ²™ç®±åœ¨æœ¬åœ°åˆ›å»ºéš”ç¦»çš„å®¹å™¨ç¯å¢ƒï¼Œæä¾›æ›´ç»†ç²’åº¦çš„èµ„æºæ§åˆ¶ã€‚

```mermaid
classDiagram
class DockerSandbox {
+create() DockerSandbox
+run_command(cmd, timeout) str
+read_file(path) str
+write_file(path, content) str
+copy_from(src_path, dst_path) None
+copy_to(src_path, dst_path) None
+cleanup() None
}
DockerSandbox : create() åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨
DockerSandbox : run_command() åœ¨å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤
DockerSandbox : read_file() è¯»å–å®¹å™¨å†…æ–‡ä»¶
DockerSandbox : write_file() å†™å…¥æ–‡ä»¶åˆ°å®¹å™¨
DockerSandbox : copy_from() ä»å®¹å™¨å¤åˆ¶æ–‡ä»¶
DockerSandbox : copy_to() å¤åˆ¶æ–‡ä»¶åˆ°å®¹å™¨
DockerSandbox : cleanup() æ¸…ç†èµ„æº
```

**å›¾æº**  
- [app/sandbox/core/sandbox.py](file://app/sandbox/core/sandbox.py#L1-L463)

### æ²™ç®±å®¢æˆ·ç«¯
æ²™ç®±å®¢æˆ·ç«¯æä¾›ç»Ÿä¸€çš„æ¥å£è®¿é—®ä¸åŒç±»å‹çš„æ²™ç®±ã€‚

```mermaid
classDiagram
class BaseSandboxClient {
+create(config, volume_bindings) None
+run_command(command, timeout) str
+copy_from(container_path, local_path) None
+copy_to(local_path, container_path) None
+read_file(path) str
+write_file(path, content) str
+cleanup() None
}
class LocalSandboxClient {
+DockerSandbox sandbox
+create(config, volume_bindings) None
+run_command(command, timeout) str
+copy_from(container_path, local_path) None
+copy_to(local_path, container_path) None
+read_file(path) str
+write_file(path, content) str
+cleanup() None
}
BaseSandboxClient <|-- LocalSandboxClient : å®ç°
LocalSandboxClient --> DockerSandbox : ä½¿ç”¨
```

**å›¾æº**  
- [app/sandbox/client.py](file://app/sandbox/client.py#L1-L202)

## å·¥å…·è°ƒç”¨æµç¨‹åˆ†æ
### å·¥å…·è°ƒç”¨æµç¨‹
å·¥å…·è°ƒç”¨æµç¨‹ä»ä»£ç†æ€è€ƒå¼€å§‹ï¼Œç»è¿‡å·¥å…·é€‰æ‹©ã€æ‰§è¡Œåˆ°ç»“æœå¤„ç†ã€‚

```mermaid
sequenceDiagram
participant Agent as ToolCallAgent
participant LLM as LLM
participant Tools as ToolCollection
participant Tool as å…·ä½“å·¥å…·
Agent->>LLM : ask_tool(messages, tools)
LLM-->>Agent : response with tool_calls
Agent->>Agent : è§£æå·¥å…·è°ƒç”¨
Agent->>Agent : è®°å½•æ€è€ƒæ—¥å¿—
loop æ¯ä¸ªå·¥å…·è°ƒç”¨
Agent->>Agent : é‡ç½®_base64_image
Agent->>Agent : è°ƒç”¨execute_tool(command)
Agent->>Tools : execute(name, tool_input)
Tools->>Tool : æ‰§è¡Œå…·ä½“å·¥å…·
Tool-->>Tools : è¿”å›æ‰§è¡Œç»“æœ
Tools-->>Agent : è¿”å›ç»“æœ
Agent->>Agent : å¤„ç†ç‰¹æ®Šå·¥å…·
Agent->>Agent : è®°å½•æ‰§è¡Œæ—¥å¿—
Agent->>Agent : åˆ›å»ºå·¥å…·æ¶ˆæ¯
Agent->>Agent : æ·»åŠ æ¶ˆæ¯åˆ°å†…å­˜
end
Agent->>Agent : è¿”å›æ‰€æœ‰ç»“æœ
```

**å›¾æº**  
- [app/agent/toolcall.py](file://app/agent/toolcall.py#L130-L163)

### å·¥å…·é›†åˆç®¡ç†
`ToolCollection`ç±»ç®¡ç†æ‰€æœ‰å¯ç”¨å·¥å…·ï¼Œæä¾›å·¥å…·æ³¨å†Œå’Œæ‰§è¡Œæ¥å£ã€‚

```mermaid
classDiagram
class ToolCollection {
+Tuple[BaseTool] tools
+Dict[str, BaseTool] tool_map
+__init__(*tools) None
+to_params() List[Dict[str, Any]]
+execute(name, tool_input) ToolResult
+execute_all() List[ToolResult]
+get_tool(name) BaseTool
+add_tool(tool) ToolCollection
+add_tools(*tools) ToolCollection
}
ToolCollection : execute(name, tool_input) æ‰§è¡ŒæŒ‡å®šå·¥å…·
ToolCollection : add_tool(tool) æ·»åŠ å•ä¸ªå·¥å…·
ToolCollection : add_tools(*tools) æ·»åŠ å¤šä¸ªå·¥å…·
```

**å›¾æº**  
- [app/tool/tool_collection.py](file://app/tool/tool_collection.py#L1-L72)

### å·¥å…·æ‰§è¡Œæœºåˆ¶
å·¥å…·æ‰§è¡Œæœºåˆ¶åŒ…å«é”™è¯¯å¤„ç†ã€ç»“æœæ ¼å¼åŒ–å’Œç‰¹æ®Šå·¥å…·å¤„ç†ã€‚

```mermaid
flowchart TD
Start([å¼€å§‹å·¥å…·æ‰§è¡Œ]) --> ValidateCommand["éªŒè¯å‘½ä»¤æ ¼å¼"]
ValidateCommand --> |æ— æ•ˆ| ReturnError["è¿”å›æ ¼å¼é”™è¯¯"]
ValidateCommand --> |æœ‰æ•ˆ| GetTool["è·å–å·¥å…·å®ä¾‹"]
GetTool --> |ä¸å­˜åœ¨| ReturnUnknown["è¿”å›æœªçŸ¥å·¥å…·é”™è¯¯"]
GetTool --> |å­˜åœ¨| ParseArgs["è§£æå‚æ•°"]
ParseArgs --> |JSONé”™è¯¯| ReturnJSONError["è¿”å›JSONè§£æé”™è¯¯"]
ParseArgs --> |æˆåŠŸ| ExecuteTool["æ‰§è¡Œå·¥å…·"]
ExecuteTool --> |å¼‚å¸¸| HandleException["å¤„ç†å¼‚å¸¸"]
HandleException --> ReturnToolError["è¿”å›å·¥å…·é”™è¯¯"]
ExecuteTool --> |æˆåŠŸ| HandleSpecial["å¤„ç†ç‰¹æ®Šå·¥å…·"]
HandleSpecial --> FormatResult["æ ¼å¼åŒ–ç»“æœ"]
FormatResult --> ReturnResult["è¿”å›ç»“æœ"]
```

**å›¾æº**  
- [app/agent/toolcall.py](file://app/agent/toolcall.py#L165-L207)

## ä¼˜åŒ–å»ºè®®
### å¼‚æ­¥æ‰§è¡Œä¼˜åŒ–
é€šè¿‡å¼‚æ­¥å¹¶å‘æ‰§è¡Œå·¥å…·è°ƒç”¨ï¼Œå‡å°‘æ€»ä½“æ‰§è¡Œæ—¶é—´ã€‚

```mermaid
flowchart TD
Start([å¼€å§‹å·¥å…·æ‰§è¡Œ]) --> Sequential["ä¸²è¡Œæ‰§è¡Œ"]
Sequential --> Tool1["æ‰§è¡Œå·¥å…·1"]
Tool1 --> Tool2["æ‰§è¡Œå·¥å…·2"]
Tool2 --> Tool3["æ‰§è¡Œå·¥å…·3"]
Tool3 --> End["å®Œæˆ"]
Start --> Parallel["å¹¶è¡Œæ‰§è¡Œ"]
Parallel --> AllTools["å¹¶å‘æ‰§è¡Œæ‰€æœ‰å·¥å…·"]
AllTools --> WaitAll["ç­‰å¾…æ‰€æœ‰å·¥å…·å®Œæˆ"]
WaitAll --> End
```

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
1. ä¿®æ”¹`act()`æ–¹æ³•ï¼Œä½¿ç”¨`asyncio.gather()`å¹¶å‘æ‰§è¡Œå·¥å…·
2. ä¸ºå·¥å…·æ‰§è¡Œæ·»åŠ è¶…æ—¶æ§åˆ¶
3. å®ç°å·¥å…·æ‰§è¡Œçš„ä¼˜å…ˆçº§è°ƒåº¦

### ç»“æœç¼“å­˜æœºåˆ¶
ä¸ºé¢‘ç¹æ‰§è¡Œçš„å·¥å…·è°ƒç”¨æ·»åŠ ç»“æœç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚

```mermaid
flowchart TD
Start([å¼€å§‹å·¥å…·æ‰§è¡Œ]) --> CheckCache["æ£€æŸ¥ç¼“å­˜"]
CheckCache --> |å‘½ä¸­| ReturnCache["è¿”å›ç¼“å­˜ç»“æœ"]
CheckCache --> |æœªå‘½ä¸­| ExecuteTool["æ‰§è¡Œå·¥å…·"]
ExecuteTool --> StoreCache["å­˜å‚¨ç»“æœåˆ°ç¼“å­˜"]
StoreCache --> ReturnResult["è¿”å›ç»“æœ"]
```

**å®ç°æ–¹æ¡ˆ**ï¼š
1. æ·»åŠ ç¼“å­˜è£…é¥°å™¨åˆ°å·¥å…·æ‰§è¡Œæ–¹æ³•
2. ä½¿ç”¨LRUç¼“å­˜ç­–ç•¥ç®¡ç†å†…å­˜ä½¿ç”¨
3. ä¸ºç¼“å­˜ç»“æœè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´

### å¹¶å‘æ§åˆ¶
é€šè¿‡é™åˆ¶å¹¶å‘æ•°ï¼Œé¿å…èµ„æºè¿‡åº¦æ¶ˆè€—ã€‚

```mermaid
flowchart TD
Start([å¼€å§‹å·¥å…·æ‰§è¡Œ]) --> Semaphore["è·å–ä¿¡å·é‡"]
Semaphore --> |è·å–æˆåŠŸ| ExecuteTool["æ‰§è¡Œå·¥å…·"]
Semaphore --> |ç­‰å¾…| Wait["ç­‰å¾…å…¶ä»–ä»»åŠ¡å®Œæˆ"]
Wait --> |è·å–æˆåŠŸ| ExecuteTool
ExecuteTool --> Release["é‡Šæ”¾ä¿¡å·é‡"]
Release --> End["å®Œæˆ"]
```

**å®ç°æ–¹æ¡ˆ**ï¼š
1. åœ¨`ToolCallAgent`ä¸­æ·»åŠ å¹¶å‘æ§åˆ¶ä¿¡å·é‡
2. ä¸ºä¸åŒç±»å‹çš„å·¥å…·è®¾ç½®ä¸åŒçš„å¹¶å‘é™åˆ¶
3. å®ç°åŠ¨æ€å¹¶å‘è°ƒæ•´ç­–ç•¥

### æ—¥å¿—çº§åˆ«è°ƒæ•´
æ ¹æ®è¿è¡Œç¯å¢ƒè°ƒæ•´æ—¥å¿—çº§åˆ«ï¼Œå‡å°‘ä¸å¿…è¦çš„I/Oæ“ä½œã€‚

```mermaid
flowchart TD
Start([å¼€å§‹]) --> CheckEnv["æ£€æŸ¥è¿è¡Œç¯å¢ƒ"]
CheckEnv --> |å¼€å‘ç¯å¢ƒ| SetDebug["è®¾ç½®DEBUGçº§åˆ«"]
CheckEnv --> |ç”Ÿäº§ç¯å¢ƒ| SetInfo["è®¾ç½®INFOçº§åˆ«"]
SetDebug --> EnableFileLog["å¯ç”¨æ–‡ä»¶æ—¥å¿—"]
SetInfo --> DisableFileLog["ç¦ç”¨æ–‡ä»¶æ—¥å¿—"]
EnableFileLog --> End
DisableFileLog --> End
```

**å®ç°æ–¹æ¡ˆ**ï¼š
1. æ ¹æ®é…ç½®æ–‡ä»¶è®¾ç½®æ—¥å¿—çº§åˆ«
2. ä¸ºå…³é”®è·¯å¾„æ·»åŠ æ€§èƒ½æ—¥å¿—
3. å®ç°æ—¥å¿—é‡‡æ ·æœºåˆ¶ï¼Œå‡å°‘æ—¥å¿—é‡

## æ€§èƒ½ç›‘æ§ä¸åŸºå‡†æµ‹è¯•
### æ€§èƒ½ç›‘æ§æŒ‡æ ‡
å»ºç«‹å…¨é¢çš„æ€§èƒ½ç›‘æ§ä½“ç³»ï¼Œè·Ÿè¸ªå…³é”®æ€§èƒ½æŒ‡æ ‡ã€‚

```mermaid
graph TD
PerformanceMetrics[æ€§èƒ½ç›‘æ§æŒ‡æ ‡] --> ResponseTime["å“åº”æ—¶é—´"]
PerformanceMetrics --> ExecutionTime["æ‰§è¡Œæ—¶é—´"]
PerformanceMetrics --> MemoryUsage["å†…å­˜ä½¿ç”¨"]
PerformanceMetrics --> CPUUsage["CPUä½¿ç”¨"]
PerformanceMetrics --> LogVolume["æ—¥å¿—é‡"]
ResponseTime --> ThinkTime["æ€è€ƒæ—¶é—´"]
ResponseTime --> ActTime["æ‰§è¡Œæ—¶é—´"]
ExecutionTime --> ToolTime["å·¥å…·æ‰§è¡Œæ—¶é—´"]
ExecutionTime --> SandboxTime["æ²™ç®±æ“ä½œæ—¶é—´"]
MemoryUsage --> AgentMemory["ä»£ç†å†…å­˜"]
MemoryUsage --> SandboxMemory["æ²™ç®±å†…å­˜"]
MemoryUsage --> ToolMemory["å·¥å…·å†…å­˜"]
CPUUsage --> AgentCPU["ä»£ç†CPU"]
CPUUsage --> SandboxCPU["æ²™ç®±CPU"]
CPUUsage --> ToolCPU["å·¥å…·CPU"]
LogVolume --> ConsoleLog["æ§åˆ¶å°æ—¥å¿—"]
LogVolume --> FileLog["æ–‡ä»¶æ—¥å¿—"]
```

### åŸºå‡†æµ‹è¯•æ–¹æ³•
å»ºç«‹æ ‡å‡†åŒ–çš„åŸºå‡†æµ‹è¯•æµç¨‹ï¼Œè¯„ä¼°ä¼˜åŒ–æ•ˆæœã€‚

```mermaid
flowchart TD
Start([å¼€å§‹åŸºå‡†æµ‹è¯•]) --> Setup["è®¾ç½®æµ‹è¯•ç¯å¢ƒ"]
Setup --> PrepareData["å‡†å¤‡æµ‹è¯•æ•°æ®"]
PrepareData --> DefineScenarios["å®šä¹‰æµ‹è¯•åœºæ™¯"]
DefineScenarios --> Scenario1["ç®€å•ä»»åŠ¡åœºæ™¯"]
DefineScenarios --> Scenario2["å¤æ‚ä»»åŠ¡åœºæ™¯"]
DefineScenarios --> Scenario3["é«˜è´Ÿè½½åœºæ™¯"]
Scenario1 --> ExecuteTest["æ‰§è¡Œæµ‹è¯•"]
Scenario2 --> ExecuteTest
Scenario3 --> ExecuteTest
ExecuteTest --> CollectMetrics["æ”¶é›†æ€§èƒ½æŒ‡æ ‡"]
CollectMetrics --> AnalyzeResults["åˆ†æç»“æœ"]
AnalyzeResults --> GenerateReport["ç”ŸæˆæŠ¥å‘Š"]
GenerateReport --> End["å®Œæˆ"]
```

**æµ‹è¯•åœºæ™¯**ï¼š
1. **ç®€å•ä»»åŠ¡**ï¼šå•ä¸ªå·¥å…·è°ƒç”¨ï¼Œå¿«é€Ÿå®Œæˆ
2. **å¤æ‚ä»»åŠ¡**ï¼šå¤šä¸ªå·¥å…·è°ƒç”¨ï¼Œæ¶‰åŠæ–‡ä»¶æ“ä½œå’Œè®¡ç®—
3. **é«˜è´Ÿè½½**ï¼šå¹¶å‘æ‰§è¡Œå¤šä¸ªä»£ç†ä»»åŠ¡

## ç»“è®º
é€šè¿‡å¯¹OpenManusçš„æ·±å…¥åˆ†æï¼Œæˆ‘ä»¬è¯†åˆ«äº†åœ¨é«˜è´Ÿè½½æˆ–å¤æ‚ä»»åŠ¡åœºæ™¯ä¸‹çš„ä¸»è¦æ€§èƒ½ç“¶é¢ˆï¼ŒåŒ…æ‹¬ä»£ç†å“åº”å»¶è¿Ÿã€å·¥å…·æ‰§è¡Œç¼“æ…¢ã€å†…å­˜å ç”¨è¿‡é«˜å’Œæ—¥å¿—I/Oé˜»å¡ç­‰é—®é¢˜ã€‚åŸºäº`app/logger.py`çš„æ—¥å¿—æœºåˆ¶ï¼Œæˆ‘ä»¬æå‡ºäº†å¯ç”¨è°ƒè¯•æ—¥å¿—å’Œåˆ†æå…³é”®è·¯å¾„è€—æ—¶çš„æ–¹æ³•ã€‚ç»“åˆæ²™ç®±æ‰§è¡Œæœºåˆ¶å’Œå·¥å…·è°ƒç”¨æµç¨‹ï¼Œæˆ‘ä»¬è¯†åˆ«äº†èµ„æºå¯†é›†å‹æ“ä½œï¼Œå¹¶æå‡ºäº†å¼‚æ­¥æ‰§è¡Œã€ç»“æœç¼“å­˜ã€å¹¶å‘æ§åˆ¶å’Œæ—¥å¿—çº§åˆ«è°ƒæ•´ç­‰ä¼˜åŒ–å»ºè®®ã€‚æœ€åï¼Œæˆ‘ä»¬æä¾›äº†æ€§èƒ½ç›‘æ§æŒ‡æ ‡å»ºè®®å’ŒåŸºå‡†æµ‹è¯•æ–¹æ³•ï¼Œå¸®åŠ©ç”¨æˆ·è¯„ä¼°ç³»ç»Ÿä¼˜åŒ–æ•ˆæœã€‚è¿™äº›ä¼˜åŒ–æªæ–½å°†æ˜¾è‘—æå‡OpenManusåœ¨é«˜è´Ÿè½½åœºæ™¯ä¸‹çš„æ€§èƒ½è¡¨ç°ã€‚