# 工具系统

<cite>
**本文档中引用的文件**  
- [base.py](file://app/tool/base.py)
- [python_execute.py](file://app/tool/python_execute.py)
- [bash.py](file://app/tool/bash.py)
- [file_operators.py](file://app/tool/file_operators.py)
- [data_visualization.py](file://app/tool/chart_visualization/data_visualization.py)
- [google_search.py](file://app/tool/search/google_search.py)
- [bing_search.py](file://app/tool/search/bing_search.py)
- [baidu_search.py](file://app/tool/search/baidu_search.py)
- [duckduckgo_search.py](file://app/tool/search/duckduckgo_search.py)
- [tool_collection.py](file://app/tool/tool_collection.py)
</cite>

## 目录
1. [简介](#简介)
2. [基础工具](#基础工具)
3. [网络工具](#网络工具)
4. [可视化工具](#可视化工具)
5. [自定义工具开发](#自定义工具开发)
6. [安全与性能最佳实践](#安全与性能最佳实践)

## 简介
OpenManus 提供了一套完整的工具系统，支持基础操作、网络搜索、数据可视化和自定义扩展。本系统基于 `BaseTool` 抽象类构建，所有工具均继承自该类，确保接口一致性与可扩展性。工具通过 `ToolCollection` 进行统一管理，并支持异步执行与结果标准化处理。

## 基础工具

### Python 执行工具
`PythonExecute` 工具允许在安全沙箱中执行 Python 代码片段。支持设置执行超时（默认 5 秒），防止无限循环或长时间阻塞。代码输出通过重定向 `stdout` 捕获，仅 `print` 输出可见，函数返回值不会被捕获。该工具使用多进程隔离执行环境，避免对主进程造成影响。

**使用场景**：数据处理、算法验证、快速原型开发。

**Section sources**
- [python_execute.py](file://app/tool/python_execute.py#L8-L74)

### Bash 命令工具
`Bash` 工具用于在终端中执行 Shell 命令。支持交互式会话管理，可通过空命令获取未完成输出，或发送 `ctrl+c` 中断当前进程。命令执行具有 120 秒超时机制，若超时将自动终止并提示重启工具。支持后台运行长时任务（如 `python3 app.py > log.txt 2>&1 &`）。

**使用场景**：系统操作、服务启停、文件管理。

**Section sources**
- [bash.py](file://app/tool/bash.py#L115-L151)

### 文件操作工具
文件操作通过 `FileOperator` 协议实现，支持本地与沙箱两种环境。核心功能包括：
- `read_file`：读取文件内容
- `write_file`：写入文件内容
- `exists`：检查路径是否存在
- `is_directory`：判断是否为目录
- `run_command`：执行命令并获取输出

`LocalFileOperator` 和 `SandboxFileOperator` 分别实现本地与沙箱环境下的文件操作，确保跨环境一致性。

**使用场景**：文件读写、目录遍历、脚本自动化。

**Section sources**
- [file_operators.py](file://app/tool/file_operators.py#L15-L38)

## 网络工具

### 搜索服务
OpenManus 集成了多种搜索引擎工具，均继承自 `WebSearchEngine` 基类，统一返回 `SearchItem` 结构化结果。

#### Google 搜索
`GoogleSearchEngine` 使用 `googlesearch` 库执行搜索，支持高级搜索模式，返回标题、URL 和描述信息。

#### Bing 搜索
`BingSearchEngine` 使用 `requests` 和 `BeautifulSoup` 抓取 Bing 搜索结果，具备反爬机制（随机 User-Agent），支持分页解析。

#### 百度搜索
`BaiduSearchEngine` 基于 `baidusearch` 库实现，兼容多种返回格式（字符串、字典、对象），自动提取标题、链接和摘要。

#### DuckDuckGo 搜索
`DuckDuckGoSearchEngine` 使用 `duckduckgo-search` SDK，支持结构化文本搜索，结果包含标题、链接和正文摘要。

所有搜索工具均支持指定结果数量（默认 10 条），并通过 `perform_search` 方法统一调用。

**功能特性**：
- 统一结果格式（`SearchItem`）
- 支持自定义结果数量
- 异常处理与容错机制

**Section sources**
- [base.py](file://app/tool/search/base.py#L19-L39)
- [google_search.py](file://app/tool/search/google_search.py#L1-L33)
- [bing_search.py](file://app/tool/search/bing_search.py#L1-L144)
- [baidu_search.py](file://app/tool/search/baidu_search.py#L1-L54)
- [duckduckgo_search.py](file://app/tool/search/duckduckgo_search.py#L1-L57)

## 可视化工具

### 数据可视化工具
`DataVisualization` 工具基于外部 Node.js 服务（`chartVisualize.ts`）实现图表生成。支持两种模式：
- **图表生成**：根据 JSON 配置文件中的 CSV 路径和图表标题生成可视化图表
- **洞察添加**：为已有图表添加 AI 生成的分析洞察

支持输出格式：`html`（交互式）和 `png`（静态图像）。语言可选中文（`zh`）或英文（`en`）。工具通过 `npx ts-node` 启动 TypeScript 脚本，传递 LLM 配置、数据集和任务类型参数。

**工作流程**：
1. 读取 JSON 配置文件
2. 加载 CSV 数据并转换为 JSON 格式
3. 并行调用 `invoke_vmind` 生成图表
4. 汇总结果并返回成功/错误信息

**Section sources**
- [data_visualization.py](file://app/tool/chart_visualization/data_visualization.py#L14-L262)

## 自定义工具开发

### 继承 BaseTool
所有自定义工具必须继承 `BaseTool` 类，并实现 `execute` 抽象方法。基本结构如下：

```python
class MyCustomTool(BaseTool):
    name: str = "my_tool"
    description: str = "A custom tool for specific tasks."
    parameters: dict = {
        "type": "object",
        "properties": {
            "input": {"type": "string", "description": "Input parameter"}
        },
        "required": ["input"]
    }

    async def execute(self, input: str) -> ToolResult:
        # 实现具体逻辑
        return self.success_response({"result": "done"})
```

### 注册到工具集合
使用 `ToolCollection.add_tool()` 或 `add_tools()` 方法将新工具注册到集合中：

```python
tools = ToolCollection()
tools.add_tool(MyCustomTool())
```

### 异步执行处理
所有工具方法均为 `async`，需使用 `await` 调用。`ToolCollection.execute()` 方法支持异步执行单个工具，`execute_all()` 支持顺序执行所有工具。

**Section sources**
- [base.py](file://app/tool/base.py#L77-L172)
- [tool_collection.py](file://app/tool/tool_collection.py#L47-L70)

## 安全与性能最佳实践

### 安全考虑
- **Python 执行隔离**：使用多进程防止代码注入影响主进程
- **Bash 命令限制**：不支持交互式命令，超时自动终止
- **文件操作权限**：沙箱环境限制文件访问范围
- **搜索请求防护**：Bing 搜索使用随机 User-Agent 防止被封禁

### 性能优化
- **异步并发**：数据可视化任务使用 `asyncio.gather` 并行处理
- **连接复用**：Bing 搜索使用 `requests.Session` 复用 HTTP 连接
- **缓存机制**：建议在上层逻辑中实现结果缓存
- **资源清理**：确保多进程和子进程正确终止

**Section sources**
- [python_execute.py](file://app/tool/python_execute.py#L8-L74)
- [bash.py](file://app/tool/bash.py#L115-L151)
- [data_visualization.py](file://app/tool/chart_visualization/data_visualization.py#L14-L262)
- [bing_search.py](file://app/tool/search/bing_search.py#L1-L144)