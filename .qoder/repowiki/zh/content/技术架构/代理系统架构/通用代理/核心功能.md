# 核心功能

<cite>
**本文档中引用的文件**  
- [python_execute.py](file://app/tool/python_execute.py)
- [browser_use_tool.py](file://app/tool/browser_use_tool.py)
- [str_replace_editor.py](file://app/tool/str_replace_editor.py)
- [ask_human.py](file://app/tool/ask_human.py)
- [terminate.py](file://app/tool/terminate.py)
- [base.py](file://app/tool/base.py)
- [file_operators.py](file://app/tool/file_operators.py)
- [manus.py](file://app/agent/manus.py)
</cite>

## 目录
1. [Python执行工具](#python执行工具)
2. [浏览器使用工具](#浏览器使用工具)
3. [字符串替换编辑器](#字符串替换编辑器)
4. [人工交互工具](#人工交互工具)
5. [终止工具](#终止工具)
6. [工具集成与调用流程](#工具集成与调用流程)
7. [异常处理策略](#异常处理策略)

## Python执行工具

PythonExecute工具是OpenManus代理中用于安全执行Python代码的核心组件。该工具通过多进程机制在沙箱环境中执行代码，确保主进程的安全性。工具的核心实现位于`app/tool/python_execute.py`文件中，继承自BaseTool基类，遵循统一的工具接口规范。

工具通过multiprocessing模块创建独立进程执行代码，主进程通过Manager.dict()与子进程共享执行结果。执行过程中，工具重定向sys.stdout到StringIO缓冲区，捕获所有print输出，但不捕获函数返回值。这种设计确保了输出的可见性，同时避免了潜在的安全风险。代码执行具有5秒默认超时限制，超时后进程将被终止，防止无限循环或长时间运行的代码影响代理性能。

工具的参数定义清晰，仅接受"code"一个必需参数，即要执行的Python代码字符串。执行结果以字典形式返回，包含"observation"（执行输出或错误信息）和"success"（执行状态）两个字段。这种标准化的输出格式便于上层代理解析和处理执行结果。

**Section sources**
- [python_execute.py](file://app/tool/python_execute.py#L8-L74)
- [base.py](file://app/tool/base.py#L100-L181)

## 浏览器使用工具

BrowserUseTool是OpenManus代理中实现浏览器自动化操作的核心工具，基于Playwright框架构建。该工具位于`app/tool/browser_use_tool.py`文件中，提供了丰富的浏览器操作能力，包括页面导航、元素交互、内容提取和标签管理等功能。

工具通过BrowserUseBrowser和BrowserContext类管理浏览器实例和上下文，确保浏览器状态的持久性。工具支持多种操作动作，如"go_to_url"、"click_element"、"input_text"、"scroll_down"等，每个动作都有明确的参数要求和依赖关系。例如，"click_element"动作需要"index"参数，"input_text"动作需要"index"和"text"两个参数。

工具实现了异步锁机制（asyncio.Lock），确保在多任务环境下浏览器操作的线程安全。浏览器初始化过程在`_ensure_browser_initialized`方法中完成，支持通过配置文件设置代理、无头模式等浏览器参数。工具还集成了WebSearch功能，支持通过"web_search"动作执行网络搜索并导航到结果页面。

对于内容提取，工具提供了"extract_content"动作，结合LLM能力从网页中提取特定信息。该功能首先获取页面内容并转换为Markdown格式，然后通过LLM的函数调用能力提取与目标相关的信息，实现了智能化的内容抓取。

**Section sources**
- [browser_use_tool.py](file://app/tool/browser_use_tool.py#L38-L566)
- [manus.py](file://app/agent/manus.py#L30-L35)

## 字符串替换编辑器

StrReplaceEditor工具是OpenManus代理中用于文件内容精准替换的核心组件，位于`app/tool/str_replace_editor.py`文件中。该工具支持查看、创建、编辑和撤销文件操作，为代理提供了强大的文件操作能力。

工具的核心功能包括"view"（查看文件）、"create"（创建文件）、"str_replace"（字符串替换）、"insert"（插入文本）和"undo_edit"（撤销编辑）五种命令。每种命令都有明确的参数要求和执行逻辑。例如，"str_replace"命令需要"old_str"和"new_str"参数，分别表示要替换的原始字符串和新字符串。

工具实现了沙箱支持，通过`_get_operator`方法根据配置决定使用本地文件操作符（LocalFileOperator）还是沙箱文件操作符（SandboxFileOperator）。这种设计确保了在不同执行环境下的兼容性和安全性。工具还维护了文件编辑历史（_file_history），支持通过"undo_edit"命令撤销最近的编辑操作。

对于字符串替换操作，工具实施了严格的唯一性检查，确保"old_str"在文件中只出现一次。如果匹配到多个位置，工具将返回错误提示，要求用户提供更具体的上下文以确保替换的准确性。这种设计避免了意外的批量替换，提高了操作的安全性。

**Section sources**
- [str_replace_editor.py](file://app/tool/str_replace_editor.py#L59-L431)
- [file_operators.py](file://app/tool/file_operators.py#L50-L158)

## 人工交互工具

AskHuman工具是OpenManus代理中实现人机交互流程的关键组件，位于`app/tool/ask_human.py`文件中。该工具为代理提供了向人类用户请求帮助的能力，弥补了自动化系统的局限性。

工具的实现非常简洁，仅包含一个"execute"方法，该方法接收"inquire"参数（即要询问用户的问题），并通过Python的input()函数等待用户输入。这种设计使得代理可以在遇到无法自动解决的问题时，主动向用户寻求指导或确认。

工具的参数定义明确，"inquire"是必需的字符串参数，表示要向用户提出的问题。执行结果直接返回用户输入的文本内容，便于代理根据用户反馈调整后续操作。这种简单而有效的交互机制，使得OpenManus代理能够处理需要人类判断或专业知识的复杂任务。

在实际应用中，当代理遇到模糊的指令、不确定的决策点或需要验证的信息时，可以调用AskHuman工具暂停自动化流程，等待用户输入。这种人机协作模式提高了系统的灵活性和可靠性，特别是在处理复杂或敏感任务时。

**Section sources**
- [ask_human.py](file://app/tool/ask_human.py#L3-L20)
- [manus.py](file://app/agent/manus.py#L30-L35)

## 终止工具

Terminate工具是OpenManus代理中用于优雅终止执行流程的组件，位于`app/tool/terminate.py`文件中。该工具为代理提供了明确的任务完成信号机制，确保代理在完成任务后能够正确结束执行。

工具的参数定义包含一个必需的"status"参数，枚举值为"success"或"failure"，表示任务完成的状态。这种设计使得代理不仅能够通知任务结束，还能传达任务执行的结果，为上层系统提供完整的执行反馈。

执行结果返回一个格式化的字符串，表明交互已完成及完成状态。这种标准化的输出格式便于系统日志记录和状态监控。在实际应用中，当代理判断所有任务都已成功完成或无法继续执行时，会调用Terminate工具结束当前会话。

该工具在Manus代理的special_tool_names列表中被特别标记，表明其特殊地位。代理在执行过程中会监控是否调用了终止工具，一旦检测到终止调用，将停止后续的思考和执行循环，释放相关资源，完成整个代理流程。

**Section sources**
- [terminate.py](file://app/tool/terminate.py#L7-L24)
- [manus.py](file://app/agent/manus.py#L30-L35)

## 工具集成与调用流程

OpenManus代理通过ToolCollection类统一管理所有可用工具，实现了工具的集中注册和调用。在Manus代理的初始化过程中，所有核心工具（包括PythonExecute、BrowserUseTool、StrReplaceEditor、AskHuman和Terminate）都被添加到available_tools集合中。

工具调用流程遵循标准的异步执行模式。当代理决定调用某个工具时，会通过工具的execute方法传递参数并等待执行结果。执行结果以ToolResult对象形式返回，包含输出、错误信息等字段，便于代理解析和处理。

工具间的数据流通过代理的内存系统（memory）进行管理。前一个工具的执行结果会被添加到消息历史中，作为后续决策的上下文。这种设计实现了工具间的协作和状态传递，支持复杂的多步骤任务执行。

对于需要持久状态的工具（如BrowserUseTool），代理通过BrowserContextHelper类管理浏览器上下文，确保在多次调用之间保持浏览器状态的一致性。这种状态管理机制使得代理能够执行需要跨步骤保持上下文的复杂任务。

**Section sources**
- [manus.py](file://app/agent/manus.py#L30-L35)
- [base.py](file://app/tool/base.py#L100-L181)

## 异常处理策略

OpenManus代理的各个工具都实现了完善的异常处理机制，确保在错误情况下能够提供有意义的反馈并保持系统稳定性。每个工具的execute方法都包含try-catch块，捕获执行过程中的异常并转换为标准化的错误响应。

对于PythonExecute工具，异常处理包括代码执行异常和超时处理。当代码执行出错时，异常信息会被捕获并作为观察结果返回；当执行超时时，进程会被终止并返回超时提示。这种双重保护机制确保了代码执行的安全性。

BrowserUseTool通过异步锁和上下文管理确保浏览器操作的线程安全，并在异常情况下返回详细的错误信息。StrReplaceEditor工具在文件操作前进行严格的路径验证，防止无效的文件操作。

所有工具都遵循统一的错误报告格式，通过ToolResult对象的error字段传递错误信息。这种标准化的错误处理机制使得代理能够一致地处理各种异常情况，提高了系统的可靠性和可维护性。

**Section sources**
- [python_execute.py](file://app/tool/python_execute.py#L8-L74)
- [browser_use_tool.py](file://app/tool/browser_use_tool.py#L38-L566)
- [str_replace_editor.py](file://app/tool/str_replace_editor.py#L59-L431)
- [base.py](file://app/tool/base.py#L100-L181)