# 状态管理

<cite>
**本文档中引用的文件**  
- [planning.py](file://app/flow/planning.py)
- [planning.py](file://app/tool/planning.py)
</cite>

## 目录
1. [任务状态生命周期](#任务状态生命周期)  
2. [当前步骤识别机制](#当前步骤识别机制)  
3. [步骤完成状态更新](#步骤完成状态更新)  
4. [计划文本生成与进度统计](#计划文本生成与进度统计)  
5. [状态异常处理与降级策略](#状态异常处理与降级策略)

## 任务状态生命周期

`PlanStepStatus` 枚举定义了任务计划中步骤的四种核心状态，用于精确追踪任务执行进度：

- **NOT_STARTED**：步骤尚未开始，初始状态
- **IN_PROGRESS**：步骤正在执行中
- **COMPLETED**：步骤已成功完成
- **BLOCKED**：步骤因外部依赖或错误被阻塞

这些状态通过 `PlanningTool` 工具进行管理，支持 `create`、`update`、`mark_step` 等命令操作。状态转换遵循严格的业务逻辑，确保任务流程的可追踪性和一致性。

**Section sources**  
- [planning.py](file://app/flow/planning.py#L15-L41)

## 当前步骤识别机制

`_get_current_step_info` 方法负责识别当前应执行的首个未完成步骤，并自动将其标记为 `IN_PROGRESS` 状态。

该方法首先从 `planning_tool.plans` 中获取当前计划数据，遍历步骤列表，检查每个步骤的状态。若状态为 `NOT_STARTED` 或 `IN_PROGRESS`（通过 `get_active_statuses()` 获取），则判定为当前待执行步骤。

一旦识别成功，系统会尝试通过 `planning_tool.execute(command="mark_step")` 将该步骤状态更新为 `IN_PROGRESS`。若更新失败（如网络异常），系统将直接操作内存存储，更新 `step_statuses` 列表，确保状态变更的最终一致性。

此机制确保了任务流的连续性，即使在外部工具调用失败的情况下，也能通过内存降级策略维持状态同步。

**Section sources**  
- [planning.py](file://app/flow/planning.py#L212-L274)

## 步骤完成状态更新

`_mark_step_completed` 方法用于将当前步骤标记为 `COMPLETED` 状态。

该方法通过调用 `planning_tool.execute()` 发送 `mark_step` 命令，将指定步骤的状态更新为 `COMPLETED`。若远程调用失败，系统会进入容错流程：直接访问 `planning_tool.plans` 内存存储，确保 `step_statuses` 列表长度足够，并将对应索引处的状态设置为 `COMPLETED`。

此双重保障机制（远程调用 + 内存直写）确保了状态更新的可靠性，防止因临时故障导致任务进度丢失。

**Section sources**  
- [planning.py](file://app/flow/planning.py#L305-L334)

## 计划文本生成与进度统计

`_get_plan_text` 方法优先通过 `planning_tool.execute(command="get")` 获取格式化计划文本。若调用失败，则降级调用 `_generate_plan_text_from_storage`，直接从内存生成文本。

`_generate_plan_text_from_storage` 方法执行以下核心逻辑：
1. 统计各状态步骤数量（`status_counts`）
2. 计算完成进度百分比（`progress`）
3. 使用 `get_status_marks()` 映射状态符号：
   - `[✓]` → COMPLETED
   - `[→]` → IN_PROGRESS
   - `[!]` → BLOCKED
   - `[ ]` → NOT_STARTED
4. 生成包含标题、进度、状态分布和步骤列表的完整文本

该机制确保了即使在工具服务不可用时，仍能通过内存数据生成可读的计划视图，保障用户对任务进度的可见性。

**Section sources**  
- [planning.py](file://app/flow/planning.py#L336-L403)

## 状态异常处理与降级策略

系统实现了多层次的异常容错机制：

1. **状态更新容错**：当 `mark_step` 命令执行失败时，直接操作 `planning_tool.plans` 内存存储，确保状态变更不丢失。
2. **数据读取降级**：当 `get` 命令失败时，自动切换至 `_generate_plan_text_from_storage`，从内存重建计划文本。
3. **列表长度保护**：在更新 `step_statuses` 时，使用 `while` 循环确保列表长度足够，避免索引越界。
4. **日志记录**：所有异常均通过 `logger.warning` 记录，便于问题追踪。

这些策略共同构成了一个高可用的状态管理系统，能够在网络波动、服务中断等异常情况下，依然保持任务状态的准确性和一致性。

**Section sources**  
- [planning.py](file://app/flow/planning.py#L212-L403)
- [planning.py](file://app/tool/planning.py#L71-L362)