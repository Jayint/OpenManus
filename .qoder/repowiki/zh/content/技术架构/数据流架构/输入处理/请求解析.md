# 请求解析

<cite>
**本文档引用的文件**
- [schema.py](file://app/schema.py)
- [base.py](file://app/agent/base.py)
- [llm.py](file://app/llm.py)
- [sb_browser_tool.py](file://app/tool/sandbox/sb_browser_tool.py)
</cite>

## 目录
1. [简介](#简介)
2. [Message类结构](#message类结构)
3. [用户消息创建机制](#用户消息创建机制)
4. [角色类型定义与验证](#角色类型定义与验证)
5. [消息转换为字典](#消息转换为字典)
6. [完整转换流程](#完整转换流程)
7. [错误处理机制](#错误处理机制)

## 简介
本文档详细描述OpenManus系统中用户请求的参数解析机制，重点分析Message类如何处理用户输入、创建消息对象以及进行格式转换。文档涵盖了从原始用户输入到Message对象的完整转换流程，包括content和base64_image参数的处理、角色类型验证、字典格式转换以及错误处理机制。

## Message类结构
Message类是OpenManus系统中表示对话消息的核心数据结构，继承自Pydantic的BaseModel。该类定义了消息的基本属性和操作方法。

```mermaid
classDiagram
class Message {
+role : ROLE_TYPE
+content : Optional[str]
+tool_calls : Optional[List[ToolCall]]
+name : Optional[str]
+tool_call_id : Optional[str]
+base64_image : Optional[str]
+__add__(other) : List[Message]
+__radd__(other) : List[Message]
+to_dict() : dict
+user_message(content, base64_image) : Message
+system_message(content) : Message
+assistant_message(content, base64_image) : Message
+tool_message(content, name, tool_call_id, base64_image) : Message
+from_tool_calls(tool_calls, content, base64_image, **kwargs) : Message
}
class Role {
+SYSTEM : "system"
+USER : "user"
+ASSISTANT : "assistant"
+TOOL : "tool"
}
class ToolCall {
+id : str
+type : str
+function : Function
}
class Function {
+name : str
+arguments : str
}
Message --> Role : "使用"
Message --> ToolCall : "包含"
ToolCall --> Function : "包含"
```

**图表来源**
- [schema.py](file://app/schema.py#L53-L155)

**本节来源**
- [schema.py](file://app/schema.py#L53-L155)

## 用户消息创建机制
Message类提供了user_message工厂方法来创建用户消息，该方法是处理用户请求的核心入口。

### user_message工厂方法
user_message是一个类方法，用于创建具有用户角色的消息实例。该方法接收content和可选的base64_image参数，返回一个Message对象。

```mermaid
flowchart TD
Start([开始]) --> ValidateContent["验证content参数"]
ValidateContent --> ContentValid{"content有效?"}
ContentValid --> |否| ThrowError["抛出类型错误"]
ContentValid --> |是| CreateMessage["创建Message实例"]
CreateMessage --> SetRole["设置role为Role.USER"]
SetRole --> SetContent["设置content属性"]
SetContent --> SetImage["设置base64_image属性"]
SetImage --> ReturnMessage["返回Message对象"]
ReturnMessage --> End([结束])
style Start fill:#f9f,stroke:#333
style End fill:#f9f,stroke:#333
style ThrowError fill:#fdd,stroke:#333
```

**图表来源**
- [schema.py](file://app/schema.py#L99-L103)

**本节来源**
- [schema.py](file://app/schema.py#L99-L103)

### content参数处理
content参数是用户消息的主要文本内容，必须为字符串类型。在创建消息时，系统会直接将传入的content值赋给Message对象的content字段。

### base64_image参数处理
base64_image参数用于处理图像数据，其处理流程如下：

1. 接收base64编码的图像字符串
2. 验证base64格式的有效性
3. 检查图像大小限制（最大10MB）
4. 验证图像尺寸（最大8192x8192像素）
5. 确认支持的图像格式（JPEG、PNG、GIF、BMP、WEBP、TIFF）

```mermaid
flowchart TD
Start([开始]) --> CheckBase64["检查base64格式"]
CheckBase64 --> ValidFormat{"格式有效?"}
ValidFormat --> |否| ReturnInvalid["返回格式错误"]
ValidFormat --> |是| DecodeImage["解码base64数据"]
DecodeImage --> CheckSize["检查图像大小"]
CheckSize --> WithinLimit{"大小在限制内?"}
WithinLimit --> |否| ReturnSizeError["返回大小超限错误"]
WithinLimit --> |是| CheckDimensions["检查图像尺寸"]
CheckDimensions --> ValidDimensions{"尺寸有效?"}
ValidDimensions --> |否| ReturnDimError["返回尺寸错误"]
ValidDimensions --> |是| CheckFormat["检查图像格式"]
CheckFormat --> Supported{"格式支持?"}
Supported --> |否| ReturnFormatError["返回格式不支持错误"]
Supported --> |是| Success["处理成功"]
Success --> End([结束])
style Start fill:#f9f,stroke:#333
style End fill:#f9f,stroke:#333
style ReturnInvalid fill:#fdd,stroke:#333
style ReturnSizeError fill:#fdd,stroke:#333
style ReturnDimError fill:#fdd,stroke:#333
style ReturnFormatError fill:#fdd,stroke:#333
```

**图表来源**
- [sb_browser_tool.py](file://app/tool/sandbox/sb_browser_tool.py#L113-L156)
- [sb_browser_tool.py](file://app/tool/sandbox/sb_browser_tool.py#L158-L182)

**本节来源**
- [schema.py](file://app/schema.py#L99-L103)
- [sb_browser_tool.py](file://app/tool/sandbox/sb_browser_tool.py#L113-L182)

## 角色类型定义与验证
Message类的role字段定义了消息发送者的角色类型，系统通过枚举和类型注解确保角色值的有效性。

### 角色类型定义
系统定义了四种角色类型，通过Role枚举类实现：

```python
class Role(str, Enum):
    SYSTEM = "system"
    USER = "user"
    ASSISTANT = "assistant"
    TOOL = "tool"
```

### 角色验证规则
角色验证通过以下机制实现：

1. 使用Python的Enum类确保角色值的枚举性
2. 通过Literal类型注解限制可接受的字符串值
3. 在创建消息时进行角色值验证

```mermaid
stateDiagram-v2
[*] --> 初始化
初始化 --> 角色定义 : 定义Role枚举
角色定义 --> 类型生成 : 生成ROLE_VALUES
类型生成 --> 类型注解 : 创建ROLE_TYPE
类型注解 --> 消息创建 : 在Message类中使用
消息创建 --> 角色验证 : 创建消息时验证
角色验证 --> 有效角色 : 返回Message实例
角色验证 --> 无效角色 : 抛出ValueError
有效角色 --> [*]
无效角色 --> [*]
```

**图表来源**
- [schema.py](file://app/schema.py#L6-L12)
- [schema.py](file://app/schema.py#L15-L16)

**本节来源**
- [schema.py](file://app/schema.py#L6-L16)

## 消息转换为字典
Message类提供了to_dict方法，用于将消息对象转换为字典格式，以便与外部系统交互。

### to_dict方法实现
to_dict方法将Message对象转换为符合OpenAI消息格式的字典：

```mermaid
flowchart TD
Start([开始]) --> CreateDict["创建基础字典"]
CreateDict --> AddRole["添加role字段"]
AddRole --> CheckContent["检查content是否存在"]
CheckContent --> ContentExists{"content存在?"}
ContentExists --> |是| AddContent["添加content字段"]
ContentExists --> |否| SkipContent["跳过content"]
CheckContent --> CheckToolCalls["检查tool_calls是否存在"]
CheckToolCalls --> ToolCallsExist{"tool_calls存在?"}
ToolCallsExist --> |是| AddToolCalls["添加tool_calls字段"]
ToolCallsExist --> |否| SkipToolCalls["跳过tool_calls"]
CheckToolCalls --> CheckName["检查name是否存在"]
CheckName --> NameExists{"name存在?"}
NameExists --> |是| AddName["添加name字段"]
NameExists --> |否| SkipName["跳过name"]
CheckName --> CheckToolCallId["检查tool_call_id是否存在"]
CheckToolCallId --> ToolCallIdExists{"tool_call_id存在?"}
ToolCallIdExists --> |是| AddToolCallId["添加tool_call_id字段"]
ToolCallIdExists --> |否| SkipToolCallId["跳过tool_call_id"]
CheckToolCallId --> CheckImage["检查base64_image是否存在"]
CheckImage --> ImageExists{"base64_image存在?"}
ImageExists --> |是| AddImage["添加base64_image字段"]
ImageExists --> |否| SkipImage["跳过base64_image"]
AddImage --> ReturnDict["返回字典"]
SkipImage --> ReturnDict
ReturnDict --> End([结束])
style Start fill:#f9f,stroke:#333
style End fill:#f9f,stroke:#333
```

**图表来源**
- [schema.py](file://app/schema.py#L83-L96)

**本节来源**
- [schema.py](file://app/schema.py#L83-L96)

### 图像消息格式转换
当消息包含base64_image时，系统会将其转换为特定格式：

```mermaid
flowchart TD
Start([开始]) --> CheckSupport["检查模型是否支持图像"]
CheckSupport --> SupportsImages{"支持图像?"}
SupportsImages --> |否| StandardFormat["标准文本格式"]
SupportsImages --> |是| CheckContent["检查现有content"]
CheckContent --> NoContent{"无content?"}
NoContent --> |是| InitEmptyList["初始化空列表"]
NoContent --> |否| CheckContentStr["检查content是否为字符串"]
CheckContentStr --> IsString{"是字符串?"}
IsString --> |是| ConvertToTextObj["转换为文本对象列表"]
IsString --> |否| CheckContentList["检查content是否为列表"]
CheckContentList --> IsList{"是列表?"}
IsList --> |是| ConvertStrItems["转换字符串项"]
IsList --> |否| HandleError["处理错误"]
ConvertStrItems --> AddImageObj["添加图像对象"]
ConvertToTextObj --> AddImageObj
InitEmptyList --> AddImageObj
AddImageObj --> FormatImageURL["格式化image_url"]
FormatImageURL --> ReturnResult["返回结果"]
StandardFormat --> ReturnResult
HandleError --> ReturnResult
ReturnResult --> End([结束])
style Start fill:#f9f,stroke:#333
style End fill:#f9f,stroke:#333
style HandleError fill:#fdd,stroke:#333
```

**图表来源**
- [llm.py](file://app/llm.py#L303-L331)

**本节来源**
- [llm.py](file://app/llm.py#L303-L331)

## 完整转换流程
从原始用户输入到Message对象的完整转换流程如下：

```mermaid
sequenceDiagram
participant 用户 as "用户"
participant Agent as "Agent"
participant Message as "Message类"
participant LLM as "LLM"
用户->>Agent : 发送请求(文本, 图像)
Agent->>Message : 调用user_message方法
Message->>Message : 验证content参数
Message->>Message : 验证base64_image格式
Message->>Message : 创建Message实例
Message-->>Agent : 返回Message对象
Agent->>Agent : 添加到内存
Agent->>LLM : 调用format_messages
LLM->>LLM : 调用to_dict方法
LLM->>LLM : 处理图像格式
LLM-->>Agent : 返回格式化消息
Agent-->>LLM : 发送处理后的消息
Note over Message,LLM : 消息创建与格式化阶段
```

**图表来源**
- [schema.py](file://app/schema.py#L99-L103)
- [schema.py](file://app/schema.py#L83-L96)
- [llm.py](file://app/llm.py#L283-L301)

**本节来源**
- [schema.py](file://app/schema.py#L83-L103)
- [llm.py](file://app/llm.py#L283-L301)

## 错误处理机制
系统实现了全面的错误处理机制，确保对无效输入的正确响应。

### 空内容处理
当content参数为空或无效时，系统会抛出类型错误：

```mermaid
flowchart TD
Start([开始]) --> CheckContent["检查content参数"]
CheckContent --> ContentEmpty{"content为空?"}
ContentEmpty --> |是| ThrowTypeError["抛出TypeError"]
ContentEmpty --> |否| ContentValid{"content有效?"}
ContentValid --> |否| ThrowTypeError
ContentValid --> |是| ProcessNormal["正常处理"]
ProcessNormal --> End([结束])
ThrowTypeError --> End
style Start fill:#f9f,stroke:#333
style End fill:#f9f,stroke:#333
style ThrowTypeError fill:#fdd,stroke:#333
```

### 错误角色类型处理
当提供无效的角色类型时，系统会抛出ValueError：

```mermaid
flowchart TD
Start([开始]) --> CheckRole["检查角色类型"]
CheckRole --> ValidRole{"角色有效?"}
ValidRole --> |是| ProcessNormal["正常处理"]
ValidRole --> |否| ThrowValueError["抛出ValueError"]
ProcessNormal --> End([结束])
ThrowValueError --> End
style Start fill:#f9f,stroke:#333
style End fill:#f9f,stroke:#333
style ThrowValueError fill:#fdd,stroke:#333
```

### 图像验证错误处理
图像验证过程中可能遇到多种错误情况：

```mermaid
flowchart TD
Start([开始]) --> CheckImage["检查base64_image"]
CheckImage --> EmptyOrShort{"空或过短?"}
EmptyOrShort --> |是| ReturnEmptyError["返回空字符串错误"]
EmptyOrShort --> |否| DataURLFormat{"data URL格式?"}
DataURLFormat --> |是| ExtractBase64["提取base64部分"]
DataURLFormat --> |否| ContinueValidation["继续验证"]
ExtractBase64 --> ContinueValidation
ContinueValidation --> InvalidChars{"无效字符?"}
InvalidChars --> |是| ReturnCharError["返回字符错误"]
InvalidChars --> |否| LengthValid{"长度有效?"}
LengthValid --> |否| ReturnLengthError["返回长度错误"]
LengthValid --> |是| DecodeFail{"解码失败?"}
DecodeFail --> |是| ReturnDecodeError["返回解码错误"]
DecodeFail --> |否| SizeExceed{"大小超限?"}
SizeExceed --> |是| ReturnSizeError["返回大小错误"]
SizeExceed --> |否| FormatSupport{"格式支持?"}
FormatSupport --> |否| ReturnFormatError["返回格式错误"]
FormatSupport --> |是| DimensionValid{"尺寸有效?"}
DimensionValid --> |否| ReturnDimError["返回尺寸错误"]
DimensionValid --> |是| Success["验证成功"]
Success --> End([结束])
style Start fill:#f9f,stroke:#333
style End fill:#f9f,stroke:#333
style ReturnEmptyError fill:#fdd,stroke:#333
style ReturnCharError fill:#fdd,stroke:#333
style ReturnLengthError fill:#fdd,stroke:#333
style ReturnDecodeError fill:#fdd,stroke:#333
style ReturnSizeError fill:#fdd,stroke:#333
style ReturnFormatError fill:#fdd,stroke:#333
style ReturnDimError fill:#fdd,stroke:#333
```

**图表来源**
- [sb_browser_tool.py](file://app/tool/sandbox/sb_browser_tool.py#L113-L156)
- [sb_browser_tool.py](file://app/tool/sandbox/sb_browser_tool.py#L158-L182)

**本节来源**
- [sb_browser_tool.py](file://app/tool/sandbox/sb_browser_tool.py#L113-L182)