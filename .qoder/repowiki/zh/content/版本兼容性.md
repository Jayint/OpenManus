# 版本兼容性

<cite>
**本文档中引用的文件**  
- [main.py](file://main.py)
- [run_mcp.py](file://run_mcp.py)
- [run_flow.py](file://run_flow.py)
- [config.py](file://app/config.py)
- [manus.py](file://app/agent/manus.py)
- [config.example.toml](file://config/config.example.toml)
- [mcp.example.json](file://config/mcp.example.json)
</cite>

## 目录
1. [简介](#简介)
2. [版本历史与变更日志](#版本历史与变更日志)
3. [升级路径与迁移指南](#升级路径与迁移指南)
4. [配置迁移](#配置迁移)
5. [API 变更与破坏性更新](#api-变更与破坏性更新)
6. [兼容性保证](#兼容性保证)
7. [依赖项要求](#依赖项要求)
8. [升级最佳实践](#升级最佳实践)

## 简介
OpenManus 是一个开源的通用 AI 智能体框架，支持多种任务处理模式和工具集成。本兼容性文档旨在为用户提供清晰的版本演进路径，详细说明各版本之间的变更、新功能、修复问题以及升级注意事项。通过本文档，用户可以安全地从旧版本迁移到新版本，确保系统稳定性和功能连续性。

## 版本历史与变更日志
根据当前代码库分析，OpenManus 的核心功能和架构已趋于稳定，主要通过配置文件和模块化设计支持功能扩展。以下是基于代码结构和配置的版本特性分析：

- **初始版本 (v0.1)**  
  基础智能体框架实现，支持 `main.py` 单智能体模式运行，提供基本的工具调用能力。

- **MCP 工具支持版本 (v0.2)**  
  引入 Model Context Protocol (MCP) 支持，通过 `run_mcp.py` 启动 MCP 工具版本，增强外部工具集成能力。

- **多智能体流程版本 (v0.3)**  
  新增多智能体协作模式，通过 `run_flow.py` 支持规划流程，集成 `DataAnalysis` 等专用智能体。

- **配置驱动版本 (v0.4)**  
  实现完全配置化的系统行为控制，通过 `config.toml` 和 `mcp.json` 文件管理 LLM、浏览器、搜索、沙箱和 MCP 服务器等核心配置。

**主要变更**：
- 新增 MCP 服务器动态连接与工具发现机制
- 引入数据可视化工具 `chart_visualization`
- 增强沙箱执行环境配置选项
- 支持多种 LLM 提供商（Anthropic、Azure、Google、Ollama）

**已修复问题**：
- 修复 MCP 工具变更时的动态更新问题
- 优化浏览器上下文管理，避免资源泄漏
- 改进配置加载机制，支持默认值和覆盖

**Section sources**
- [main.py](file://main.py)
- [run_mcp.py](file://run_mcp.py)
- [run_flow.py](file://run_flow.py)
- [config.py](file://app/config.py)

## 升级路径与迁移指南
从旧版本升级到最新版本需要遵循以下步骤，确保配置和功能的平滑过渡。

### 1. 备份现有配置
在升级前，请备份现有的 `config.toml` 和任何自定义配置文件。

### 2. 更新代码库
```bash
git pull origin main
```

### 3. 安装最新依赖
```bash
uv pip install -r requirements.txt
```

### 4. 验证新功能
测试新版本的核心功能：
```bash
python main.py
python run_mcp.py
python run_flow.py
```

**Section sources**
- [main.py](file://main.py)
- [run_mcp.py](file://run_mcp.py)
- [run_flow.py](file://run_flow.py)

## 配置迁移
新版本的配置系统更加灵活和模块化，需要对旧配置进行适当调整。

### 全局 LLM 配置迁移
旧版本：
```toml
[llm]
model = "gpt-4o"
base_url = "https://api.openai.com/v1"
api_key = "sk-..."
```

新版本保持兼容，但支持更多选项：
```toml
[llm]
model = "claude-3-7-sonnet-20250219"
base_url = "https://api.anthropic.com/v1/"
api_key = "YOUR_API_KEY"
max_tokens = 8192
temperature = 0.0
api_type = "anthropic"  # 新增字段
```

### MCP 服务器配置迁移
新增独立的 `mcp.json` 配置文件，用于定义 MCP 服务器：

```json
{
    "mcpServers": {
      "server1": {
        "type": "sse",
        "url": "http://localhost:8000/sse"
      }
    }
}
```

**Section sources**
- [config.example.toml](file://config/config.example.toml)
- [mcp.example.json](file://config/mcp.example.json)
- [config.py](file://app/config.py)

## API 变更与破坏性更新
### 核心类变更
`Manus` 类增加了 MCP 服务器动态管理功能：

```python
class Manus(ToolCallAgent):
    mcp_clients: MCPClients = Field(default_factory=MCPClients)
    connected_servers: Dict[str, str] = Field(default_factory=dict)
    
    async def initialize_mcp_servers(self) -> None:
        """初始化配置的 MCP 服务器连接"""
    
    async def connect_mcp_server(self, server_url: str, server_id: str = "") -> None:
        """连接到 MCP 服务器并添加其工具"""
    
    async def disconnect_mcp_server(self, server_id: str = "") -> None:
        """断开 MCP 服务器连接并移除其工具"""
```

### 配置类变更
`Config` 类现在支持更细粒度的配置管理：

```python
class Config:
    @property
    def mcp_config(self) -> MCPSettings:
        """获取 MCP 配置"""
    
    @property
    def run_flow_config(self) -> RunflowSettings:
        """获取 Run Flow 配置"""
```

### 破坏性更新
- 移除了硬编码的 MCP 服务器地址，必须通过 `mcp.json` 配置
- `config.toml` 中的 `llm` 配置现在必须包含 `api_type` 字段
- 浏览器配置的默认安全设置已更改

**Section sources**
- [manus.py](file://app/agent/manus.py)
- [config.py](file://app/config.py)

## 兼容性保证
OpenManus 遵循以下兼容性原则：

1. **向后兼容性**：主要运行脚本 `main.py`、`run_mcp.py` 和 `run_flow.py` 的命令行接口保持稳定。
2. **配置兼容性**：`config.toml` 的基本结构保持不变，新增字段均为可选。
3. **API 稳定性**：核心智能体接口 `ToolCallAgent` 保持稳定，扩展功能通过继承实现。
4. **工具兼容性**：本地工具接口保持不变，MCP 工具通过标准化协议集成。

**不保证兼容的领域**：
- 内部实现细节和私有方法
- 实验性功能（如多智能体流程）
- 第三方依赖的具体版本

**Section sources**
- [main.py](file://main.py)
- [run_mcp.py](file://run_mcp.py)
- [run_flow.py](file://run_flow.py)
- [manus.py](file://app/agent/manus.py)

## 依赖项要求
升级到最新版本需要满足以下依赖要求：

### Python 依赖
- Python 3.12 或更高版本
- 主要依赖项版本：
  - `pydantic>=2.0`
  - `tomli` 或 `tomllib`（Python 3.11+ 内置）
  - `uv`（推荐的包管理器）

### 外部工具依赖
- **Playwright**：用于浏览器自动化（可选）
  ```bash
  playwright install
  ```
- **Node.js**：用于数据可视化工具
  - 需要 Node.js 14+ 运行 `chart_visualization` 工具
- **Docker**：用于沙箱环境（如果启用）

### 配置文件依赖
- `config.toml`：必须包含 `api_type` 字段
- `mcp.json`：MCP 服务器配置（如果使用 MCP 功能）

**Section sources**
- [config.py](file://app/config.py)
- [config.example.toml](file://config/config.example.toml)

## 升级最佳实践
为确保升级过程顺利，建议遵循以下最佳实践：

1. **逐步升级**：不要跳过多个版本，逐个版本升级并测试。
2. **配置验证**：使用 `config.example.toml` 作为参考，确保新配置项正确设置。
3. **功能测试**：升级后，测试所有关键功能，包括：
   - 基本智能体运行
   - MCP 工具调用
   - 数据分析功能
4. **监控日志**：关注启动日志，特别是配置加载和 MCP 服务器连接信息。
5. **备份恢复**：始终保持旧版本的备份，以便在出现问题时快速回滚。

通过遵循本文档的指南，用户可以安全、顺利地完成 OpenManus 的版本升级，充分利用新版本的功能和改进。

**Section sources**
- [main.py](file://main.py)
- [run_mcp.py](file://run_mcp.py)
- [run_flow.py](file://run_flow.py)
- [config.py](file://app/config.py)
- [manus.py](file://app/agent/manus.py)